# Version 1.2.0 - Implementation Summary

**Target Version:** 1.2.0  
**Current Version:** 1.1.14  
**Site URL:** https://1stfairfieldscouthall.com  
**Status:** Ready for Implementation

---

## âœ… Clarifications Confirmed

### 1. Checklist Display
**What you want:** Checkboxes for each item + progress bar that fills as items are checked

**Implementation:**
- Booking edit page: 5 checkboxes + progress bar
- Dashboard: Progress bar column showing % complete
- Auto-save when checkbox clicked
- Progress bar color changes based on completion

### 2. Blackout Reasons
**Confirmed:** Yes, add optional "reason" field for blackout periods

### 3. OAuth Redirect URI
**Site URL:** `https://1stfairfieldscouthall.com`  
**Redirect URI:** `https://1stfairfieldscouthall.com/wp-content/plugins/antigravity-booking/includes/oauth-callback.php`

### 4. Implementation Priority
1. **Priority 1:** OAuth Google Calendar integration
2. **Priority 2:** Overnight booking times (per day + special dates)
3. **Priority 3:** Booking approval checklist + progress bar
4. **Priority 4:** Dashboard sorting
5. **Priority 5:** Blackout dates calendar
6. **Priority 6:** Fix booking edit page save

---

## ğŸ¯ Feature Specifications

### Feature 1: OAuth Google Calendar (PRIORITY 1)

**User Flow:**
1. Admin goes to Settings > Google Calendar
2. Enters OAuth Client ID and Secret (from Google Cloud Console)
3. Clicks "Authorize with Google"
4. Redirected to Google authorization page
5. Approves access
6. Redirected back to WordPress
7. Success message: "Connected to Google Calendar!"
8. Bookings now sync automatically

**Technical:**
- New class: `Antigravity_Booking_Google_OAuth`
- OAuth 2.0 authorization code flow
- Automatic token refresh
- Encrypted token storage
- Replaces service account completely

**Files:**
- NEW: `includes/class-antigravity-booking-google-oauth.php`
- NEW: `includes/oauth-callback.php`
- MODIFY: `includes/class-antigravity-booking-settings.php`
- MODIFY: `includes/class-antigravity-booking-google-calendar.php`

---

### Feature 2: Overnight Times Per Day (PRIORITY 2)

**Configuration:**
```
Monday:    22:00 - 10:00 (next day)
Tuesday:   22:00 - 10:00
Wednesday: 22:00 - 10:00
Thursday:  22:00 - 10:00
Friday:    23:00 - 11:00  <- Different!
Saturday:  23:00 - 11:00  <- Different!
Sunday:    22:00 - 10:00

Special Dates:
Dec 24, 2026: 20:00 - 08:00 (Christmas Eve)
Dec 31, 2026: 23:00 - 12:00 (New Year's Eve)
```

**Technical:**
- New option: `antigravity_booking_overnight_times` (array per day)
- New option: `antigravity_booking_special_hours` (array per date)
- Update `Antigravity_Booking_Availability::get_overnight_end()`
- Settings UI with time pickers for each day
- Special dates table with add/remove

**Files:**
- MODIFY: `includes/class-antigravity-booking-settings.php`
- MODIFY: `includes/class-antigravity-booking-availability.php`

---

### Feature 3: Booking Approval Checklist (PRIORITY 3)

**Checklist Items:**
1. â˜ Rental Agreement
2. â˜ Deposit
3. â˜ Certificate of Insurance
4. â˜ Key Arrangement
5. â˜ Deposit Returned

**Progress Bar:**
- 0/5 checked = 0% (Red bar)
- 1/5 checked = 20% (Red bar)
- 2/5 checked = 40% (Orange bar)
- 3/5 checked = 60% (Orange bar)
- 4/5 checked = 80% (Blue bar)
- 5/5 checked = 100% (Green bar)

**Where Displayed:**
- **Booking Edit Page:** Full checklist with checkboxes + progress bar
- **Dashboard:** Progress bar column only (compact)

**Behavior:**
- Checkboxes auto-save via AJAX when clicked
- Progress bar updates in real-time
- Not required for approval (tracking only)
- Shows last updated timestamp

**Technical:**
- New meta fields: `_checklist_rental_agreement`, `_checklist_deposit`, etc.
- New meta field: `_checklist_progress` (0-100)
- New AJAX endpoint: `update_booking_checklist`
- New meta box on booking edit page
- New column in dashboard table

**Files:**
- MODIFY: `includes/class-antigravity-booking-cpt.php` (add meta box)
- MODIFY: `includes/class-antigravity-booking-dashboard.php` (add column)
- NEW: `admin/js/checklist-manager.js`
- NEW: `admin/css/checklist.css`

---

### Feature 4: Dashboard Sorting (PRIORITY 4)

**Sortable Columns:**
- Start Date (default, descending)
- Customer Name
- Cost
- Status
- Progress (checklist completion)

**Behavior:**
- Click column header to sort
- Click again to toggle ascending/descending
- Visual indicator: â†‘ (asc) â†“ (desc) â†• (not sorted)
- Remembers sort preference in URL params

**Technical:**
- Add `orderby` and `order` URL parameters
- Modify WP_Query in dashboard
- Add JavaScript click handlers
- Add CSS for sortable headers

**Files:**
- MODIFY: `includes/class-antigravity-booking-dashboard.php`
- NEW: `admin/js/dashboard-sorting.js`

---

### Feature 5: Blackout Dates Calendar (PRIORITY 5)

**Interface:**
- Visual calendar (using Flatpickr)
- Click to select dates
- Shift+click to select ranges
- Quick add form for date ranges
- List of current blackout periods
- Optional reason field for each period

**Behavior:**
- Selected dates highlighted in red
- Blackout periods listed below calendar
- Easy remove buttons
- Dates not available for booking on frontend
- Shows in dashboard as "Blacked Out" entries

**Technical:**
- New custom post type: `blackout_date`
- Meta fields: `_blackout_start_date`, `_blackout_end_date`, `_blackout_reason`
- Flatpickr calendar integration
- AJAX endpoints: `add_blackout_date`, `remove_blackout_date`
- Migration from old text field format

**Files:**
- NEW: `includes/class-antigravity-booking-blackout.php`
- MODIFY: `includes/class-antigravity-booking-settings.php`
- MODIFY: `includes/class-antigravity-booking-dashboard.php`
- MODIFY: `includes/class-antigravity-booking-availability.php`
- NEW: `admin/js/blackout-calendar.js`
- NEW: `admin/css/blackout-calendar.css`

---

### Feature 6: Fix Booking Edit Page (PRIORITY 6)

**Current Issue:**
- Edits don't save
- No clear save button
- Confusing UX

**Fix:**
- Add prominent "Save Changes" button
- Add unsaved changes warning
- Add success message after save
- Ensure meta box save hook fires correctly
- Add auto-save draft functionality

**Technical:**
- Verify `save_post_booking` hook
- Add explicit save button
- Add JavaScript change detection
- Add success/error messages

**Files:**
- MODIFY: `includes/class-antigravity-booking-cpt.php`

---

## ğŸ—„ï¸ Database Schema

### New Custom Post Type

**`blackout_date`**
```php
'post_title' => 'Blackout: Jan 25-28, 2026'
'post_type' => 'blackout_date'
'post_status' => 'publish'

Meta:
- '_blackout_start_date' => '2026-01-25'
- '_blackout_end_date' => '2026-01-28'
- '_blackout_reason' => 'Maintenance work'
```

### New Booking Meta Fields

**Checklist:**
```php
'_checklist_rental_agreement' => 1 (or 0)
'_checklist_deposit' => 1
'_checklist_insurance' => 1
'_checklist_key_arrangement' => 0
'_checklist_deposit_returned' => 0
'_checklist_progress' => 60 (percentage)
'_checklist_last_updated' => '2026-01-22 15:45:00'
```

### New Options

**OAuth:**
```php
'antigravity_gcal_oauth_client_id' => 'xxx.apps.googleusercontent.com'
'antigravity_gcal_oauth_client_secret' => 'GOCSPX-xxx' (encrypted)
'antigravity_gcal_oauth_access_token' => 'ya29.xxx'
'antigravity_gcal_oauth_refresh_token' => 'xxx' (encrypted)
'antigravity_gcal_oauth_expires_at' => 1737676800
'antigravity_gcal_oauth_authorized' => true
```

**Overnight Times:**
```php
'antigravity_booking_overnight_times' => array(
    'monday' => array('start' => '22:00', 'end' => '10:00'),
    'tuesday' => array('start' => '22:00', 'end' => '10:00'),
    // ... etc
)

'antigravity_booking_special_hours' => array(
    '2026-12-24' => array('start' => '20:00', 'end' => '08:00', 'reason' => 'Christmas Eve'),
    '2026-12-31' => array('start' => '23:00', 'end' => '12:00', 'reason' => 'New Year'),
)
```

---

## ğŸ” OAuth Setup Guide

### Google Cloud Console Configuration

**Step 1: Create OAuth Credentials**
1. Go to https://console.cloud.google.com
2. Select your project (or create new)
3. Navigate to: APIs & Services > Credentials
4. Click "Create Credentials" > "OAuth 2.0 Client ID"
5. Application type: "Web application"
6. Name: "Simplified Booking - 1st Fairfield Scout Hall"

**Step 2: Configure Redirect URI**
Add this exact URL:
```
https://1stfairfieldscouthall.com/wp-content/plugins/antigravity-booking/includes/oauth-callback.php
```

**Step 3: Copy Credentials**
- Copy Client ID
- Copy Client Secret
- Paste both into WordPress settings

**Step 4: Enable API**
- APIs & Services > Library
- Search "Google Calendar API"
- Click "Enable"

**Step 5: Authorize**
- Go to WordPress Settings > Google Calendar
- Click "Authorize with Google"
- Approve access
- Done!

---

## ğŸ“Š Implementation Phases

### Phase 1: OAuth Integration (8 hours)
- Create OAuth handler class
- Build authorization flow
- Implement token refresh
- Update settings page
- Remove service account code
- Test authorization flow

### Phase 2: Overnight Times (5 hours)
- Add per-day configuration UI
- Add special dates table
- Update availability logic
- Test with different times per day
- Test special date overrides

### Phase 3: Booking Checklist (4 hours)
- Add meta box to edit page
- Create AJAX save handler
- Add progress bar calculation
- Add dashboard column
- Test auto-save functionality

### Phase 4: Dashboard Sorting (2 hours)
- Add sortable column headers
- Modify query logic
- Add JavaScript handlers
- Test all sort combinations

### Phase 5: Blackout Calendar (10 hours)
- Create blackout CPT
- Build calendar interface
- Integrate with dashboard
- Update availability checking
- Migrate old blackout dates
- Test date selection and ranges

### Phase 6: Fix Edit Page (1 hour)
- Add save button
- Fix save hook
- Add success messages
- Test save functionality

**Total:** 30 hours development + 6 hours testing = **36 hours**

---

## ğŸ¨ UI Preview

### Checklist on Booking Edit Page

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Booking Approval Checklist                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ Progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 60%                    â”‚
â”‚                                                          â”‚
â”‚ â˜‘ Rental Agreement                                      â”‚
â”‚ â˜‘ Deposit                                               â”‚
â”‚ â˜‘ Certificate of Insurance                              â”‚
â”‚ â˜ Key Arrangement                                       â”‚
â”‚ â˜ Deposit Returned                                      â”‚
â”‚                                                          â”‚
â”‚ Last updated: Jan 22, 2026 at 3:45 PM                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Progress Bar in Dashboard

```
| Customer   | Start Date | Progress      | Status   |
|------------|------------|---------------|----------|
| Jane Smith | Jan 29     | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 80% | Approved |
| John Doe   | Jan 25     | â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 60% | Approved |
| Bob Johnson| Jan 24     | â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘ 40% | Pending  |
```

---

## ğŸ”„ Migration Strategy

### Automatic Migrations (On Plugin Update)

**1. Blackout Dates:**
```php
// Convert from text field to custom post type
Old: "2026-01-25\n2026-01-26\n2026-01-27"
New: 3 blackout_date posts (one per day)
```

**2. Checklist:**
```php
// Initialize for all existing bookings
All checkboxes = unchecked (0)
Progress = 0%
```

**3. Overnight Times:**
```php
// Use current default for all days
All days = 22:00 - 10:00
```

**4. OAuth:**
```php
// Clear old service account credentials
Remove: antigravity_gcal_credentials_json
Remove: antigravity_gcal_credentials_file
Add: OAuth fields (empty, needs authorization)
```

---

## ğŸ§ª Testing Plan

### OAuth Testing
- [ ] Configure OAuth in Google Cloud Console
- [ ] Enter credentials in WordPress
- [ ] Click "Authorize with Google"
- [ ] Verify redirect to Google
- [ ] Approve access
- [ ] Verify redirect back to WordPress
- [ ] Verify success message
- [ ] Test connection
- [ ] Approve a booking
- [ ] Verify event created in Google Calendar
- [ ] Wait for token to expire (or force expiry)
- [ ] Verify automatic token refresh

### Overnight Times Testing
- [ ] Set different times for Friday/Saturday
- [ ] Create overnight booking on Friday
- [ ] Verify uses Friday times (23:00-11:00)
- [ ] Add special date override for Dec 24
- [ ] Create booking on Dec 24
- [ ] Verify uses special hours (20:00-08:00)

### Checklist Testing
- [ ] Edit a booking
- [ ] Check "Rental Agreement"
- [ ] Verify progress bar updates to 20%
- [ ] Check all 5 items
- [ ] Verify progress bar shows 100% (green)
- [ ] Refresh page
- [ ] Verify checkboxes still checked
- [ ] View in dashboard
- [ ] Verify progress column shows 100%

### Dashboard Sorting Testing
- [ ] Click "Start Date" header
- [ ] Verify sorts ascending
- [ ] Click again
- [ ] Verify sorts descending
- [ ] Test sorting by Customer, Cost, Status
- [ ] Verify sort persists with filters

### Blackout Calendar Testing
- [ ] Click dates on calendar
- [ ] Verify dates highlighted
- [ ] Add date range (Jan 25-28)
- [ ] Verify 4 blackout entries created
- [ ] View in dashboard
- [ ] Verify 4 "Blacked Out" entries shown
- [ ] Try to book Jan 26 on frontend
- [ ] Verify date not available
- [ ] Remove blackout range
- [ ] Verify dates available again

### Edit Page Save Testing
- [ ] Edit booking details
- [ ] Click "Save Changes"
- [ ] Verify success message
- [ ] Refresh page
- [ ] Verify changes persisted

---

## ğŸ“¦ Deliverables

### Code Files
- 3 new PHP classes
- 3 new JavaScript files
- 2 new CSS files
- 6 modified PHP files

### Documentation
- OAuth setup guide
- User manual for new features
- Migration guide
- Troubleshooting guide

### Package
- `antigravity-booking-v1.2.0.zip`
- Includes all new features
- Backward compatible
- Auto-migration on activation

---

## ğŸš€ Implementation Order

Based on your priorities:

### Week 1: OAuth + Overnight Times
1. Implement OAuth integration (8 hours)
2. Implement overnight times per day (3 hours)
3. Implement special date overrides (2 hours)
4. Testing (3 hours)
**Deliverable:** v1.2.0-beta1

### Week 2: Checklist + Sorting
5. Implement booking checklist (4 hours)
6. Implement dashboard sorting (2 hours)
7. Testing (2 hours)
**Deliverable:** v1.2.0-beta2

### Week 3: Blackout Calendar + Polish
8. Implement blackout calendar (10 hours)
9. Fix edit page save (1 hour)
10. Final testing (4 hours)
11. Documentation (3 hours)
**Deliverable:** v1.2.0-final

---

## âœ… Success Criteria

### OAuth Integration
- âœ… Can authorize with one click
- âœ… Tokens refresh automatically
- âœ… Events sync to Google Calendar
- âœ… No Status 500 errors
- âœ… Clear error messages

### Overnight Times
- âœ… Can set different times per day
- âœ… Can add special date overrides
- âœ… Bookings use correct times
- âœ… Frontend shows correct overnight slots

### Checklist
- âœ… Checkboxes save automatically
- âœ… Progress bar updates in real-time
- âœ… Shows in dashboard
- âœ… Color-coded by completion

### Sorting
- âœ… All columns sortable
- âœ… Toggle ascending/descending
- âœ… Visual indicators clear
- âœ… Works with filters

### Blackout Calendar
- âœ… Easy to select dates/ranges
- âœ… Shows in dashboard
- âœ… Blocks frontend bookings
- âœ… Can add reasons

### Edit Page
- âœ… Changes save correctly
- âœ… Success message shown
- âœ… No confusion

---

## ğŸ”’ Security Measures

### OAuth
- State parameter validation
- Encrypted token storage
- Nonce verification
- Capability checks

### Checklist
- AJAX nonce verification
- Booking ownership validation
- Sanitized inputs

### Blackout Dates
- Date format validation
- Capability checks
- Sanitized reasons

---

## ğŸ“ Next Steps

1. **Review this plan** - Confirm all features are as expected
2. **Approve implementation** - Give go-ahead to start coding
3. **Provide Google OAuth credentials** - Or I can guide you through setup
4. **Switch to Code mode** - Begin implementation

---

**Plan Status:** âœ… Complete and Ready  
**Awaiting:** Your approval to begin implementation  
**Estimated Completion:** 3 weeks (phased delivery)  
**Risk Level:** Low (all features well-planned and tested)